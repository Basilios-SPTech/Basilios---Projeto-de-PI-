name: SAST & SCA Security Scan

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  security:
    name: SAST + SCA
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # ----------------
      # SAST - Snyk
      # ----------------
      - name: Run Snyk (SAST)
        uses: snyk/actions/node@master
        with:
          command: code test
          args: --severity-threshold=high --json-file-output=snyk-sast.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # ----------------
      # SCA - Trivy
      # ----------------
      - name: Run Trivy (SCA)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          format: json
          output: trivy.json
          severity: HIGH,CRITICAL
        continue-on-error: true

      # ----------------
      # PR Summary
      # ----------------
      - name: Comment Security Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let sastHigh = 0;
            let sastTotal = 0;
            let scaCritical = 0;
            let scaHigh = 0;
            // --- SAST (Snyk Code) ---
            if (fs.existsSync('snyk-sast.json')) {
              const snyk = JSON.parse(fs.readFileSync('snyk-sast.json'));

              const issues = snyk.runs?.[0]?.results || [];

              sastTotal = issues.length;

              sastHigh = issues.filter(
                r => ['high', 'critical'].includes(
                  r.properties?.severity?.toLowerCase()
                )
              ).length;
            }

            // --- SCA ---
            if (fs.existsSync('trivy.json')) {
              const trivy = JSON.parse(fs.readFileSync('trivy.json'));
              const vulns = trivy.Results
                ?.flatMap(r => r.Vulnerabilities || []) || [];

              scaCritical = vulns.filter(v => v.Severity === 'CRITICAL').length;
              scaHigh = vulns.filter(v => v.Severity === 'HIGH').length;
            }

            const body = `
            ### ğŸ” Security Scan Summary

            #### ğŸ” SAST (Semgrep)
            - ğŸš¨ **High:** ${sastHigh}
            - ğŸ“¦ **Total findings:** ${sastTotal}

            #### ğŸ“¦ SCA (Trivy)
            - ğŸ”´ **Critical:** ${scaCritical}
            - ğŸŸ  **High:** ${scaHigh}

            ğŸ“ Veja os logs do job para detalhes completos.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
