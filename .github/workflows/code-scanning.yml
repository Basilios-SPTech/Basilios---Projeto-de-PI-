name: SAST Security Scan
on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
  security-events: write
jobs:
  security:
    name: SAST - Semgrep + Snyk
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ----------------
      # SAST - Semgrep
      # ----------------
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          generateSarif: "0"
        continue-on-error: true
        env:
          SEMGREP_TIMEOUT: 300

      - name: Export Semgrep results
        run: |
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep semgrep \
            --config=auto \
            --json \
            --output=/src/semgrep.json \
            /src || true
        continue-on-error: true

      # ----------------
      # SAST - Snyk Code
      # ----------------
      - name: Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Snyk Code (SAST)
        uses: snyk/actions/node@master
        with:
          command: code test
          args: --severity-threshold=low --json-file-output=snyk-sast.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # ----------------
      # PR Summary
      # ----------------
      - name: Comment Security Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Semgrep results
            let semgrepCritical = 0;
            let semgrepHigh = 0;
            let semgrepMedium = 0;
            let semgrepTotal = 0;

            // Snyk results
            let snykCritical = 0;
            let snykHigh = 0;
            let snykMedium = 0;
            let snykTotal = 0;

            // --- Parse Semgrep ---
            if (fs.existsSync('semgrep.json')) {
              try {
                const semgrep = JSON.parse(fs.readFileSync('semgrep.json'));
                const results = semgrep.results || [];
                semgrepTotal = results.length;

                results.forEach(r => {
                  const severity = r.extra?.severity?.toLowerCase() || 'info';
                  if (severity === 'error' || severity === 'critical') semgrepCritical++;
                  else if (severity === 'warning' || severity === 'high') semgrepHigh++;
                  else if (severity === 'medium') semgrepMedium++;
                });
              } catch (e) {
                console.log('Error parsing Semgrep results:', e.message);
              }
            }

            // --- Parse Snyk ---
            if (fs.existsSync('snyk-sast.json')) {
              try {
                const snyk = JSON.parse(fs.readFileSync('snyk-sast.json'));
                const issues = snyk.runs?.[0]?.results || [];
                snykTotal = issues.length;

                issues.forEach(r => {
                  const severity = r.properties?.severity?.toLowerCase() || 'low';
                  if (severity === 'critical') snykCritical++;
                  else if (severity === 'high') snykHigh++;
                  else if (severity === 'medium') snykMedium++;
                });
              } catch (e) {
                console.log('Error parsing Snyk results:', e.message);
              }
            }

            const totalCritical = semgrepCritical + snykCritical;
            const totalHigh = semgrepHigh + snykHigh;
            const totalMedium = semgrepMedium + snykMedium;
            const totalFindings = semgrepTotal + snykTotal;

            const emoji = totalCritical > 0 ? 'ðŸš¨' : totalHigh > 0 ? 'âš ï¸' : 'âœ…';

            const body = `
            ### ${emoji} Security Scan Summary

            | Tool | Critical | High | Medium | Total |
            |------|----------|------|--------|-------|
            | ðŸ” **Semgrep** | ${semgrepCritical} | ${semgrepHigh} | ${semgrepMedium} | ${semgrepTotal} |
            | ðŸ **Snyk Code** | ${snykCritical} | ${snykHigh} | ${snykMedium} | ${snykTotal} |
            | **ðŸ“Š Combined** | **${totalCritical}** | **${totalHigh}** | **${totalMedium}** | **${totalFindings}** |

            ${totalCritical > 0 ? 'ðŸ”´ **Action Required:** Critical vulnerabilities found!' : ''}
            ${totalHigh > 5 ? 'ðŸŸ  **Warning:** Multiple high-severity issues detected.' : ''}

            ðŸ“Ž View detailed results in:
            - [Semgrep Dashboard](https://semgrep.dev)
            - [Snyk Dashboard](https://app.snyk.io)
            - Workflow logs above
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
