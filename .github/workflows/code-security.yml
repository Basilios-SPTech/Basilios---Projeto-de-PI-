name: Code Quality & Secrets Scan
on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
  security-events: write
jobs:
  security:
    name: Linting + Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para detectar secrets em todo histÃ³rico

      # ----------------
      # Secrets Detection - TruffleHog
      # ----------------
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --json --only-verified
        continue-on-error: true

      # ----------------
      # Secrets Detection - Detect-Secrets
      # ----------------
      - name: Run Detect-Secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline || true
          detect-secrets audit .secrets.baseline > secrets-report.txt || true
        continue-on-error: true

      # ----------------
      # Linting - ESLint (JavaScript/TypeScript)
      # ----------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true

      - name: Run ESLint
        run: |
          npx eslint . \
            --format json \
            --output-file eslint-report.json \
            --max-warnings 0 || true
        continue-on-error: true

      # ----------------
      # Security Linting - ESLint Security Plugin
      # ----------------
      - name: Run ESLint Security Rules
        run: |
          npm install --save-dev eslint-plugin-security
          npx eslint . \
            --plugin security \
            --format json \
            --output-file eslint-security.json || true
        continue-on-error: true

      # ----------------
      # PR Summary
      # ----------------
      - name: Comment Summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let secretsFound = 0;
            let lintErrors = 0;
            let lintWarnings = 0;
            let securityIssues = 0;

            // Parse TruffleHog results (check logs)
            // TruffleHog outputs to stdout, hard to parse here

            // Parse ESLint
            if (fs.existsSync('eslint-report.json')) {
              try {
                const eslint = JSON.parse(fs.readFileSync('eslint-report.json'));
                eslint.forEach(file => {
                  lintErrors += file.errorCount || 0;
                  lintWarnings += file.warningCount || 0;
                });
              } catch (e) {
                console.log('Error parsing ESLint:', e.message);
              }
            }

            // Parse ESLint Security
            if (fs.existsSync('eslint-security.json')) {
              try {
                const security = JSON.parse(fs.readFileSync('eslint-security.json'));
                security.forEach(file => {
                  securityIssues += file.errorCount || 0;
                });
              } catch (e) {
                console.log('Error parsing ESLint Security:', e.message);
              }
            }

            const emoji = secretsFound > 0 ? 'ğŸ”ğŸš¨' : lintErrors > 10 ? 'âš ï¸' : 'âœ…';

            const body = `
            ### ${emoji} Code Quality & Security Summary

            | Category | Count |
            |----------|-------|
            | ğŸ” **Secrets Detected** | ${secretsFound > 0 ? 'âš ï¸ Check logs!' : 'âœ… None'} |
            | âŒ **Lint Errors** | ${lintErrors} |
            | âš ï¸ **Lint Warnings** | ${lintWarnings} |
            | ğŸ›¡ï¸ **Security Issues** | ${securityIssues} |

            ${secretsFound > 0 ? 'ğŸš¨ **CRITICAL:** Potential secrets found! Review TruffleHog output immediately.' : ''}
            ${lintErrors > 0 ? 'âš ï¸ Fix linting errors before merging.' : ''}

            ğŸ“ Check workflow logs for detailed results.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
